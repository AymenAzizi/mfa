<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- User Form View Extension -->
    <record id="view_users_form_mfa" model="ir.ui.view">
        <field name="name">res.users.form.mfa</field>
        <field name="model">res.users</field>
        <field name="inherit_id" ref="base.view_users_form"/>
        <field name="arch" type="xml">
            <xpath expr="//notebook" position="inside">
                <page string="Multi-Factor Authentication" name="mfa_config">
                    <group>
                        <field name="mfa_enabled"/>
                        <field name="force_mfa" readonly="1"/>
                        <field name="totp_secret" invisible="1"/>
                        <field name="totp_backup_codes" invisible="1"/>
                        <field name="mfa_failed_attempts" readonly="1"/>
                        <field name="mfa_locked_until" readonly="1"/>
                    </group>
                    <group invisible="not mfa_enabled">
                        <button string="Setup MFA" type="object" name="action_setup_mfa" class="btn-primary"/>
                        <button string="Disable MFA" type="object" name="action_disable_mfa" class="btn-secondary"/>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- MFA Setup Wizard Form View -->
    <record id="view_mfa_setup_wizard_form" model="ir.ui.view">
        <field name="name">mfa.setup.wizard.form</field>
        <field name="model">mfa.setup.wizard</field>
        <field name="arch" type="xml">
            <form string="Setup Multi-Factor Authentication">
                <group>
                    <field name="user_id" invisible="1"/>
                    <field name="totp_secret" invisible="1"/>
                </group>
                
                <group invisible="show_success">
                    <div class="alert alert-info">
                        <h4>Step 1: Scan QR Code</h4>
                        <p>Use your authenticator app (Google Authenticator, Authy, etc.) to scan this QR code:</p>
                        <div class="text-center">
                            <img t-if="qr_code" t-att-src="'data:image/png;base64,' + qr_code" style="max-width: 200px;"/>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h4>Step 2: Enter Verification Code</h4>
                        <p>Enter the 6-digit code from your authenticator app:</p>
                        <field name="verification_code" placeholder="123456" maxlength="6"/>
                    </div>
                </group>
                
                <group invisible="not show_success">
                    <div class="alert alert-success">
                        <h4>MFA Setup Complete!</h4>
                        <p>Your multi-factor authentication has been enabled successfully.</p>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h4>Important: Save Your Backup Codes</h4>
                        <p>Store these backup codes in a safe place. You can use them to access your account if you lose your authenticator device:</p>
                        <pre t-esc="backup_codes" style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px;"/>
                    </div>
                </group>
                
                <footer>
                    <button string="Verify &amp; Enable MFA" type="object" name="action_verify_and_enable" class="btn-primary" invisible="show_success"/>
                    <button string="Close" type="object" name="action_close" class="btn-secondary" invisible="not show_success"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- MFA Log Tree View -->
    <record id="view_mfa_log_tree" model="ir.ui.view">
        <field name="name">mfa.log.tree</field>
        <field name="model">mfa.log</field>
        <field name="arch" type="xml">
            <tree string="MFA Audit Log">
                <field name="create_date"/>
                <field name="user_id"/>
                <field name="action"/>
                <field name="description"/>
                <field name="ip_address"/>
            </tree>
        </field>
    </record>

    <!-- MFA Log Form View -->
    <record id="view_mfa_log_form" model="ir.ui.view">
        <field name="name">mfa.log.form</field>
        <field name="model">mfa.log</field>
        <field name="arch" type="xml">
            <form string="MFA Log Entry">
                <group>
                    <field name="user_id"/>
                    <field name="action"/>
                    <field name="create_date"/>
                    <field name="ip_address"/>
                </group>
                <group>
                    <field name="description" nolabel="1"/>
                </group>
                <group>
                    <field name="user_agent" nolabel="1"/>
                </group>
            </form>
        </field>
    </record>

    <!-- MFA Log Search View -->
    <record id="view_mfa_log_search" model="ir.ui.view">
        <field name="name">mfa.log.search</field>
        <field name="model">mfa.log</field>
        <field name="arch" type="xml">
            <search string="MFA Log">
                <field name="user_id"/>
                <field name="action"/>
                <field name="ip_address"/>
                <filter string="Today" name="today" domain="[('create_date', '&gt;=', datetime.datetime.combine(context_today(), datetime.time(0,0,0)))]"/>
                <filter string="This Week" name="this_week" domain="[('create_date', '&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <filter string="Failed Attempts" name="failed" domain="[('action', '=', 'failed')]"/>
                <group expand="0" string="Group By">
                    <filter string="User" name="group_user" context="{'group_by': 'user_id'}"/>
                    <filter string="Action" name="group_action" context="{'group_by': 'action'}"/>
                    <filter string="Date" name="group_date" context="{'group_by': 'create_date:day'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- MFA Log Action -->
    <record id="action_mfa_log" model="ir.actions.act_window">
        <field name="name">MFA Audit Log</field>
        <field name="res_model">mfa.log</field>
        <field name="view_mode">tree,form</field>
        <field name="search_view_id" ref="view_mfa_log_search"/>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No MFA activity logged yet.
            </p>
            <p>
                MFA audit logs will appear here once users start using multi-factor authentication.
            </p>
        </field>
    </record>

    <!-- Menu Items -->
    <menuitem id="menu_mfa_log" 
              name="MFA Audit Log" 
              parent="base.menu_administration" 
              action="action_mfa_log" 
              sequence="100"/>
</odoo>